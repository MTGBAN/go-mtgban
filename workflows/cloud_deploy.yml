name: Deploy docker to GCP registry

on:
  push:
    branches:
      - "master"

  jobs:
    build: 
      runs-on: ubuntu-latest
      steps:
      -
        name: Checkout 
        uses: actions/checkout@v3'
      -
        name: auth
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID}}
          service_account_key: ${{ secrets.GCR_KEY }}
          export_default_credentials: true
      -
        name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      -
        name: gcloud login
        run: gcloud auth login
      -
        name: configure docker
        run: gcloud --quiet auth configure-docker
      -
        name: build image 
        run: docker build --no-cache --rm=false -t $IMAGE_NAME:latest .
      -
        name: push to GCP
        run: docker push $IMAGE_NAME:latest